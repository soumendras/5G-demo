<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Biometrics Dashboard</title>
    <style>
        :root{
            --bg:#0b1220;
            --panel:#0f1a2e;
            --line:rgba(255,255,255,.16);
            --text:#e9eefc;
            --muted:rgba(233,238,252,.72);
            --accent:#ff6b9a;
            --ok:#7CFFB2;
            --bad:#FF7C7C;
        }
        *{ box-sizing:border-box; }
        body{
            margin:0;
            background:var(--bg);
            color:var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }
        .wrap{ max-width:792px; margin:16.2px auto; padding:0 12.6px; }
        .board{ background:var(--panel); border:2px solid var(--line); border-radius:12.6px; overflow:hidden; }
        .row{ display:grid; border-top:2px solid var(--line); }
        .row:first-child{ border-top:none; }
        .two{ grid-template-columns:1fr 1fr; }
        .one{ grid-template-columns:1fr; }
        .cell{ padding:10.8px 12.6px; min-height:70.2px; position:relative; }
        .two .cell:first-child{ border-right:2px solid var(--line); }
        .label{ font-size:12.6px; color:var(--muted); margin-bottom:5.4px; }
        .headerTitle{ font-size:16.2px; font-weight:850; margin-bottom:5.4px; }
        .big{ font-size:48.6px; font-weight:750; line-height:1; color:var(--accent); white-space:nowrap; }
        .unit{ font-size:12.6px; color:var(--muted); margin-left:7.2px; font-weight:600; }
        .small{ font-size:14.4px; font-weight:650; }
        .meta{ margin-top:5.4px; font-size:10.8px; color:var(--muted); }
        .chartWrap{ padding:9px 12.6px 12.6px 12.6px; }
        .chartHeader{ display:flex; justify-content:space-between; margin-bottom:7.2px; }
        canvas{ width:100%; height:153px; display:block; border:2px solid var(--line); border-radius:10.8px; background:rgba(0,0,0,.10); }
        .msgText{ font-size:19.8px; font-weight:800; letter-spacing:.45px; }

        /* Logos */
        .logoBox{ display:flex; align-items:center; justify-content:center; min-height:81px; gap:9px; padding:9px 11px; }
        .logoBox img{ max-height:50.4px; max-width:81%; object-fit:contain; filter:drop-shadow(0 5.4px 9px rgba(0,0,0,.25)); }
        .logoPlaceholder{ color:var(--muted); font-weight:700; }

        #connClass.ok { box-shadow: inset 0 0 0 1.8px rgba(124,255,178,.22); }
        #connClass.bad { box-shadow: inset 0 0 0 1.8px rgba(255,124,124,.22); }

        @media (orientation: portrait) and (max-width: 560px){
            body { overflow: hidden; }
            .wrap { margin: 0; padding: 8.5px; height: 100vh; }
            .board { height: calc(100vh - 16.2px); }
            .two { grid-template-columns: 1fr 1fr; }
            .two .cell:first-child{ border-right: 2px solid var(--line); border-bottom: none; }
            .cell{ padding:8.1px 10.8px; min-height:52.2px; }
            .label{ font-size:11.3px; margin-bottom:4.8px; }
            .headerTitle{ font-size:14.4px; margin-bottom:4.8px; }
            .small{ font-size:12.2px; }
            .big{ font-size:36.6px; }
            .unit{ font-size:11.3px; margin-left:5.4px; }
            .meta{ display: none; }
            .chartWrap{ padding:6.3px 10.8px 8.1px 10.8px; }
            canvas{ height:94.5px; }
            .msgText{ font-size:13.1px; }
            .logoBox{ min-height:55.8px; padding:6.3px 10.8px; }
            .logoBox img{ max-height:32.4px; }
        }

        @media (orientation: portrait) and (max-width: 380px){
            .big{ font-size:32.4px; }
            canvas{ height:85.5px; }
            .logoBox img{ max-height:28.8px; }
            .headerTitle{ font-size:13.5px; }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="board">
            <!-- Top Row -->
            <div class="row two">
                <div class="cell">
                    <div class="label">Ambient T°C</div>
                    <div><span class="big" id="ambient">—</span><span class="unit">°C</span></div>
                    <div class="meta">Channel <span id="ch">—</span></div>
                </div>
                <div class="cell" id="connClass">
                    <div class="headerTitle">Biometrics Dashboard</div>
                    <div class="small" id="connState">starting…</div>
                    <div class="meta">Last update: <span id="lastUpdate">—</span></div>
                </div>
            </div>
            <!-- Core + Finger -->
            <div class="row two">
                <div class="cell">
                    <div class="label">CORE T°C</div>
                    <div><span class="big" id="core">—</span><span class="unit">°C</span></div>
                </div>
                <div class="cell">
                    <div class="label">Fingertip T°C</div>
                    <div><span class="big" id="finger">—</span><span class="unit">°C</span></div>
                </div>
            </div>
            <!-- Chart -->
            <div class="row one">
                <div class="chartWrap">
                    <div class="chartHeader">
                        <div class="label" style="margin:0;">ΔT°C (Core − Fingertip)</div>
                        <div class="small">ΔT: <span id="deltaNow">—</span><span class="unit">°C</span></div>
                    </div>
                    <canvas id="dtChart" width="900" height="340"></canvas>
                </div>
            </div>
            <!-- HR + RESP -->
            <div class="row two">
                <div class="cell">
                    <div class="label">HR (bpm)</div>
                    <div><span class="big" id="hr">—</span></div>
                </div>
                <div class="cell">
                    <div class="label">RESP (/min)</div>
                    <div><span class="big" id="resp">—</span></div>
                </div>
            </div>
            <!-- Friend/Foe -->
            <div class="row one">
                <div class="cell">
                    <div class="label">Messages: Friend/Foe</div>
                    <div class="msgText" id="friendfoe">—</div>
                    <div class="meta">Tip: send it via ThingSpeak “field7=” in your update request.</div>
                </div>
            </div>
            <!-- Logos -->
            <div class="row two">
                <div class="cell logoBox">
                    <img id="logo1" src="./ualberta.png" alt="UAlberta logo" />
                    <div id="ph1" class="logoPlaceholder" style="display:none;">UAlberta logo</div>
                </div>
                <div class="cell logoBox">
                    <img id="logo2" src="./ideas.jpg" alt="IDEaS logo" />
                    <div id="ph2" class="logoPlaceholder" style="display:none;">IDEaS logo</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const CHANNEL_ID = 3256737;
        const READ_API_KEY = "";
        const Ambient_Temp = "field1";
        const Core_Body_Temp = "field2";
        const Fingertip_Temp = "field3";
        const Heart_Rate = "field5";
        const Respiration_Rate = "field6";
        const FriendFoe_Field = "field7";
        const RESULTS = 60;
        const POLL_MS = 1000;
        const el = id => document.getElementById(id);

        function num(x){
            const v=parseFloat(x);
            return isFinite(v)?v:null;
        }
        function fmtTemp(v){ return v===null?"—":v.toFixed(1); }
        function fmtDelta(v){ return v===null?"—":v.toFixed(2); }
        function fmtInt(v){ return v===null?"—":Math.round(v); }
        function apiUrl(){
            let url=https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${RESULTS};
            if(READ_API_KEY) url+=&api_key=${encodeURIComponent(READ_API_KEY)};
            return url;
        }

        let lastFF="—";
        function drawLineChart(canvas, ys){
            const ctx=canvas.getContext("2d");
            const W=canvas.width,H=canvas.height;
            ctx.clearRect(0,0,W,H);
            ctx.strokeStyle="rgba(255,255,255,0.12)";
            ctx.lineWidth=1;
            for(let i=1;i<=4;i++){
                const y=(H*i)/5;
                ctx.beginPath();
                ctx.moveTo(10,y);
                ctx.lineTo(W-10,y);
                ctx.stroke();
            }
            const data=ys.filter(v=>isFinite(v));
            if(data.length<2){
                ctx.fillStyle="rgba(233,238,252,0.75)";
                ctx.font="20px system-ui";
                ctx.fillText("No ΔT data yet",22,H/2);
                return;
            }
            let ymin=Math.min(...data);
            let ymax=Math.max(...data);
            const pad=Math.max(0.5,(ymax-ymin)*0.15);
            ymin-=pad;
            ymax+=pad;

            function xPix(i,n){ return 10+((W-20)*(i/(n-1))); }
            function yPix(v){ const t=(v-ymin)/(ymax-ymin); return (H-10)-t*(H-20); }

            ctx.strokeStyle="rgba(255,107,154,0.95)";
            ctx.lineWidth=3;
            ctx.beginPath();
            const n=ys.length;
            let started=false;
            for(let i=0;i<n;i++){
                const v=ys[i];
                if(!isFinite(v)) continue;
                const xp=xPix(i,n), yp=yPix(v);
                if(!started){ctx.moveTo(xp,yp);started=true;} else ctx.lineTo(xp,yp);
            }
            ctx.stroke();
        }

        async function refresh(){
            try{
                const res=await fetch(apiUrl(),{cache:"no-store"});
                const data=await res.json();
                const feeds=data.feeds||[];
                if(!feeds.length) return;
                const last=feeds[feeds.length-1];
                const core=num(last[Core_Body_Temp]);
                const finger=num(last[Fingertip_Temp]);
                const amb=num(last[Ambient_Temp]);
                const hr=num(last[Heart_Rate]);
                const resp=num(last[Respiration_Rate]);

                el("ambient").textContent=fmtTemp(amb);
                el("core").textContent=fmtTemp(core);
                el("finger").textContent=fmtTemp(finger);
                el("hr").textContent=fmtInt(hr);
                el("resp").textContent=fmtInt(resp);

                const dtNow=(core===null||finger===null)?null:(core-finger);
                el("deltaNow").textContent=fmtDelta(dtNow);

                const dtSeries=feeds.map(r=>{
                    const c=num(r[Core_Body_Temp]);
                    const f=num(r[Fingertip_Temp]);
                    return (c===null||f===null)?NaN:(c-f);
                });
                drawLineChart(el("dtChart"),dtSeries);

                const rawFF=last[FriendFoe_Field];
                const ffNum=parseInt(rawFF);
                if(ffNum===1) lastFF="FRIEND";
                else if(ffNum===2) lastFF="FOE";
                const ffEl=el("friendfoe");
                ffEl.textContent=lastFF;
                if(lastFF==="FRIEND") ffEl.style.color="var(--ok)";
                else if(lastFF==="FOE") ffEl.style.color="var(--bad)";
                el("lastUpdate").textContent=new Date(last.created_at).toLocaleString();
            }catch(e){ console.error(e); }
        }

        refresh();
        setInterval(refresh,POLL_MS);
    </script>
</body>
</html>
