<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Biometrics Dashboard</title>

<style>
:root{
  --bg:#0b1220;
  --panel:#0f1a2e;
  --line:rgba(255,255,255,.16);
  --text:#e9eefc;
  --muted:rgba(233,238,252,.72);
  --accent:#ff6b9a;
  --ok:#7CFFB2;
  --bad:#FF7C7C;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

.wrap{ max-width:880px; margin:18px auto; padding:0 14px; }

.board{
  background:var(--panel);
  border:2px solid var(--line);
  border-radius:14px;
  overflow:hidden;
}

.row{ display:grid; border-top:2px solid var(--line); }
.row:first-child{ border-top:none; }
.two{ grid-template-columns:1fr 1fr; }
.one{ grid-template-columns:1fr; }

.cell{
  padding:12px 14px;
  min-height:78px;
  position:relative;
}

.two .cell:first-child{ border-right:2px solid var(--line); }

.label{
  font-size:14px;
  color:var(--muted);
  margin-bottom:6px;
}

.headerTitle{
  font-size:18px;
  font-weight:850;
  margin-bottom:6px;
}

.big{
  font-size:54px;
  font-weight:750;
  line-height:1;
  color:var(--accent);
  white-space:nowrap;
}

.unit{
  font-size:14px;
  color:var(--muted);
  margin-left:8px;
  font-weight:600;
}

.small{ font-size:16px; font-weight:650; }

.meta{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
}

.chartWrap{ padding:10px 14px 14px 14px; }

.chartHeader{
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
}

canvas{
  width:100%;
  height:170px;
  display:block;
  border:2px solid var(--line);
  border-radius:12px;
  background:rgba(0,0,0,.10);
}

.msgText{
  font-size:22px;
  font-weight:800;
  letter-spacing:.5px;
}

</style>
</head>

<body>
<div class="wrap">
<div class="board">

<!-- Top Row -->
<div class="row two">
  <div class="cell">
    <div class="label">Ambient T°C</div>
    <div><span class="big" id="ambient">—</span><span class="unit">°C</span></div>
    <div class="meta">Channel <span id="ch">—</span></div>
  </div>
  <div class="cell" id="connClass">
    <div class="headerTitle">Biometrics Dashboard</div>
    <div class="small" id="connState">starting…</div>
    <div class="meta">Last update: <span id="lastUpdate">—</span></div>
  </div>
</div>

<!-- Core + Finger -->
<div class="row two">
  <div class="cell">
    <div class="label">CORE T°C</div>
    <div><span class="big" id="core">—</span><span class="unit">°C</span></div>
  </div>
  <div class="cell">
    <div class="label">Fingertip T°C</div>
    <div><span class="big" id="finger">—</span><span class="unit">°C</span></div>
  </div>
</div>

<!-- Chart -->
<div class="row one">
  <div class="chartWrap">
    <div class="chartHeader">
      <div class="label" style="margin:0;">ΔT°C (Core − Fingertip)</div>
      <div class="small">ΔT: <span id="deltaNow">—</span><span class="unit">°C</span></div>
    </div>
    <canvas id="dtChart" width="900" height="340"></canvas>
  </div>
</div>

<!-- HR + RESP -->
<div class="row two">
  <div class="cell">
    <div class="label">HR (bpm)</div>
    <div><span class="big" id="hr">—</span></div>
  </div>
  <div class="cell">
    <div class="label">RESP (/min)</div>
    <div><span class="big" id="resp">—</span></div>
  </div>
</div>

<!-- Friend/Foe -->
<div class="row one">
  <div class="cell">
    <div class="label">Messages: Friend/Foe</div>
    <div class="msgText" id="friendfoe">—</div>
  </div>
</div>

</div>
</div>

<script>

const CHANNEL_ID = 3256737;
const READ_API_KEY = "";

const Ambient_Temp     = "field1";
const Core_Body_Temp   = "field2";
const Fingertip_Temp   = "field3";
const Heart_Rate       = "field5";
const Respiration_Rate = "field6";
const FriendFoe_Field  = "field7";

const RESULTS = 60;
const POLL_MS = 1000;  // kept at 1 second as requested

const el = id => document.getElementById(id);

function num(x){ const v=parseFloat(x); return isFinite(v)?v:null; }
function fmtTemp(v){ return v===null?"—":v.toFixed(1); }
function fmtInt(v){ return v===null?"—":Math.round(v); }

function apiUrl(){
  let url=`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${RESULTS}`;
  if(READ_API_KEY) url+=`&api_key=${encodeURIComponent(READ_API_KEY)}`;
  return url;
}

let lastFF = "—";   // persists until next valid 1/2

async function refresh(){
  try{
    const res=await fetch(apiUrl(),{cache:"no-store"});
    const data=await res.json();
    const feeds=data.feeds||[];
    if(!feeds.length) return;

    const last=feeds[feeds.length-1];

    const core=num(last[Core_Body_Temp]);
    const finger=num(last[Fingertip_Temp]);
    const amb=num(last[Ambient_Temp]);
    const hr=num(last[Heart_Rate]);
    const resp=num(last[Respiration_Rate]);

    el("ambient").textContent=fmtTemp(amb);
    el("core").textContent=fmtTemp(core);
    el("finger").textContent=fmtTemp(finger);
    el("hr").textContent=fmtInt(hr);
    el("resp").textContent=fmtInt(resp);

    const rawFF=last[FriendFoe_Field];
    const ffNum=parseInt(rawFF);

    if(ffNum===1){
      lastFF="FRIEND";
    }
    else if(ffNum===2){
      lastFF="FOE";
    }

    const ffEl=el("friendfoe");
    ffEl.textContent=lastFF;

    if(lastFF==="FRIEND"){
      ffEl.style.color="var(--ok)";
    }
    else if(lastFF==="FOE"){
      ffEl.style.color="var(--bad)";
    }

    el("lastUpdate").textContent=new Date(last.created_at).toLocaleString();

  }catch(e){
    console.error(e);
  }
}

refresh();
setInterval(refresh,POLL_MS);

</script>
</body>
</html>
